{% extends "base.html" %}

{% block content %}

<div  class="container-fluid" style="height: 100vh;">
    <div class="row" style="height: 100vh;">
        
        <div class="col-lg-3">
                <h1 style="margin: 1rem 0rem">{{ current_user.username }}'s Subjects</h1>
            <div id="subject-container" style="border: 1px solid grey; width: fit-content; padding: 1rem 1rem 1rem 1rem; min-width: 366px; height: 60vh; overflow-y: scroll;">
                
                {% for subject in subjects %}
                <div id="subjectCard">
                    <div class="card create-flowy" id="{{ subject.subject_name }}" data-status="listed">
                        
                        <div class="card-body" id="goalCardBody">
                            <h4 class="card-title" id="goalCardTitle">{{ subject.subject_name }}<i class="fas fa-circle" style="font-size: 14px; margin-right: 0.3rem; color: {{ subject_descriptions[subject.id]['color'] }}; float: right;"></i></h4>
                            <p class="card-text" style="font-size: 14px; color: grey;">{{ subject_descriptions[subject.id]['description'] }}</p>
                            <input type="hidden" id="subjectID" value="{{ subject.id }}">
                            <input type="hidden" id="cardSubjectColor" value ="{{ subject_descriptions[subject.id]['color'] }}">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="col-lg-9" id="can-col">
            <h1 style="text-align: center; margin: 1rem 0rem" id="plannerHead">Goal Planner <i class="fas fa-sitemap"></i></h1>
            <div  id="canvas" >

            </div>
            <div style="text-align: center; position: absolute; bottom: 0; left: 0; right: 0; margin-left: auto; margin-right:auto;">           
                <button type="button" id="resetGraphingCanvas" class="btn btn-danger" style="margin-right: 1rem; height: 3rem; width: 6rem; font-size: 18px; z-index: 2;">Reset</button>
                <button type="button" id="loadOpen" class="btn btn-secondary" style="margin-right: 1rem; height: 3rem; width: 6rem; font-size: 18px; z-index: 2;" data-toggle="modal" data-target="#loadModal">Plans</button>
                <button type="submit" id="saveOpen" class="btn btn-secondary" style="height: 3rem; width: 6rem; font-size: 18px;"  data-toggle="modal" data-target="#saveModal">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Save plan Modal -->
<div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Save Plan</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

            <div class="modal-body">
                <div  class="row" id="modal-row">
                    <div class="col-sm-4" style="font-size: 18px; display: flex; align-items: center;;"><label for="plan-name">Plan Name:</label><span id="required-splat" style="color: red;">*</span></div>
                    <div class="col-sm-8"><input type="text" class="form-control" name="plan_name" id="plan_name"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="submit" id="save" class="btn btn-success" data-dismiss="modal">Save</button>
                <input type="hidden" id="json_submit" name="jsonsubmit" value="">
            </div>

      </div>
    </div>
</div>

<!-- Load Plan Modal -->
<div class="modal fade" id="loadModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Load Plan</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

            <div class="modal-body">
                <div class="row" id="modal-row" style="min-height: 50px;">
                    <img src="../static/assets/loading.gif" id="planListLoading" style="display: none; margin: auto; height: 50px;">
                    <div class="col-sm-4" style="font-size: 18px; display: flex; align-items: center;" id="planLabelCol"><label>Plan Name:</label><span id="required-splat" style="color: red;">*</span></div>
                    <div class="col-sm-8" id="planListCol"><select name="plan_to_load" class="form-control" id="selectFile"></select></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" id="deletePlan" class="btn btn-danger" data-dismiss="modal" data-toggle="modal" data-target="#deleteConfirmModal">Delete</button>
                <button type="button" id="loadPlan" class="btn btn-success" data-dismiss="modal">Load</button>
            </div>

      </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Confirm Delete</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

            <div id="deleteConfirmModalBody" class="modal-body">
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" id="deleteConfirm" class="btn btn-danger">Delete</button>
            </div>

      </div>
    </div>
</div>

<!-- Save Response Modal -->
<div class="modal fade" id="saveResponseModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Save Plan</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

            <div class="modal-body" id="saveResponseMessage">

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="submit" id="overwriteSave" class="btn btn-warning" style="display: none;">Overwrite</button>
            </div>

      </div>
    </div>
</div>

<script type="text/javascript">

    window.hiddenBlocks = [];
    window.snappedBlocks = [];
    window.relationships = {};
    var spacing_x = 60;
    var spacing_y = 120;
    // Initialize Flowy
    flowy(document.getElementById("canvas"), onGrab, onRelease, onSnap, onRearrange, spacing_x, spacing_y);

    function onGrab(block){
        // When a user grabs a block
    };
    function onRelease(){
        // When a user lets go of a block w/ no parent
    };
    function onSnap(block, first, parent){
        // When a block snaps with another one. True allows snapping.
        return true;
    };
    function onRearrange(block, parent){
        // When a block is rearranged. True forces released block to snap back to original parent
    };

    var reset_graphing_canvas = document.getElementById("resetGraphingCanvas");
    reset_graphing_canvas.addEventListener("click", function(){
        var planner_head = document.getElementById('plannerHead');
        // Clears graphing canvas
        flowy.deleteBlocks();
        planner_head.innerHTML = 'Goal Planner ' + '<i class="fas fa-sitemap"></i>';
    });

    var open_load_modal = document.getElementById("loadOpen");
    open_load_modal.addEventListener("click", function() {
        // Opens load plan modal and loads in list of user's plans
        var selectBox = document.getElementById('selectFile');
        var length = selectBox.options.length;
        // Clear select options
        for (i = length-1; i >= 0; i--) {
            selectBox.options[i] = null;
        }
        // Loading Animation
        var elements_to_show_hide = [
            document.getElementById('planLabelCol'),
            document.getElementById('planListCol')
        ]
        var loading_img = document.getElementById('planListLoading');
        let plan_list_loading_animation = new Loading_Animation(loading_img, elements_to_show_hide);
        plan_list_loading_animation.start_animation();
        // Get list of user's plans from server
        $.getJSON('/list_plans', {}, function(data) {
            if (data.plan_list) {
                // Load list of user's plans as select options
                for(var i = 0, l = data.plan_list.length; i < l; i++){
                    var option = data.plan_list[i];
                    // End Loading Animation
                    plan_list_loading_animation.stop_animation();
                    selectBox.options.add( new Option(option.text, option.value) );
                }
            }
        })
    });

    
    var save_plan = document.getElementById('save');
    save_plan.addEventListener("click", function() {
        // Saves user plan currently drawn on canvas
        var test = JSON.stringify(flowy.output());
        var plan_name = $('#plan_name').val();
        // Send plan name and data to server
        $.ajax({
        url: '/save_graph',
        data: JSON.stringify({
            'plan_name': plan_name,
            'plan_graph': JSON.stringify(flowy.output())
        }),
        contentType: 'application/json',
        type: 'POST',
        success: function(response) {
            // Show response messages
            $("#saveResponseMessage").text(response.message);
            $("#saveResponseModal").modal('show');
            // Show overwrite prompt
            if (response.saved == 0) {
                $("#overwriteSave").show();
            } else {
                // Otherwise only save confirmation message
                $("#overwriteSave").hide();
            }
        },
        error: function(error) {
            console.log(error);
        }
        }).done(function(response) {
            if (response.saved == 1) {
                $('#plannerHead').html(plan_name + ' ' + '<i class="fas fa-sitemap"></i>');
            }
        });
    });

    var overwrite_plan = document.getElementById('overwriteSave');
    overwrite_plan.addEventListener('click', function() {
        // Overwrites existing user plan         
        var plan_name = $('#plan_name').val();                                                                      
        // Send plan name and data to server
        $.ajax({
            url: '/overwrite_graph',
            data: JSON.stringify({
                'plan_name': plan_name,
                'plan_graph': JSON.stringify(flowy.output())
            }),
            contentType: 'application/json',
            type: 'POST',
            success: function(response) {
                // Hide overwrite elements
                $('#overwriteSave').hide();
                // Show save confirmation message
                $("#saveResponseMessage").text(response.message);
                $("#saveResponseModal").modal('show');
            },
            error: function(error) {
                console.log(error);
            }
        }).done(function() {
            $('#plannerHead').html(plan_name + ' ' + '<i class="fas fa-sitemap"></i>');
        });
    });

    var load_plan = document.getElementById('loadPlan');
    load_plan.addEventListener('click', function() {
        // Loads plan into canvas
        // Get plan data from server
        $.getJSON('/load_graph', {
            plan_to_load: $('#selectFile').children("option:selected").val()
        }, function(data) {
                // Clear canvas before load
                flowy.deleteBlocks();
                var canvas_element = document.getElementById("canvas");
                // Log response for debugging
                console.log(data);
                // Load plan chart into canvas
                canvas_element.innerHTML = data.plan_data['html'];
                // Load chart data into flowy object
                flowy.import(data.plan_data);
            }).done(function(data) {
                $('#plannerHead').html(data.plan_name + ' ' + '<i class="fas fa-sitemap"></i>');
            });
    });

    function Loading_Animation(loading_img, elements_to_show_hide) {
        this.elements = [];
        this.loading_img = loading_img;
        for (var i = 0; i < elements_to_show_hide.length; i++) {
            this.elements.push(elements_to_show_hide[i]);
        }
    }

    Loading_Animation.prototype.start_animation = function() {
        for (var element of this.elements) {
            element.style.display = "none";
        }
        this.loading_img.style.display = "";
    }

    Loading_Animation.prototype.stop_animation = function() {
        for (var element of this.elements) {
            element.style.display = "";
        }
        this.loading_img.style.display = "none";
    }
          
</script>
{% endblock %}
